[gd_scene load_steps=14 format=2]

[ext_resource path="res://Resources/TypeFaces/dotty.regular.ttf" type="DynamicFontData" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends Node

onready var COMMON = get_node(\"/root/Common\")
var PLAYER
var MOB
var score = 0
var seconds_left = 3
var multiplier_meter_length = 0
var multiplier_meter_height = 0
var multiplier_position = null
var screen_size

func _ready():
	ready()

func ready():
	PLAYER =  get_parent().get_node(\"Player\")
	MOB =  get_parent().get_node(\"Mob\")
	PLAYER.connect(\"bombs_left\", self, \"on_bombs_left\")
	screen_size = COMMON.get_screen_size(get_parent())
	multiplier_meter_length =  screen_size.x / 10
	multiplier_meter_height = screen_size.y / 20
	multiplier_position = Vector2(screen_size.x / 2 - ((multiplier_meter_length * 5) / 2),
		screen_size.y - multiplier_meter_height)
	setup_multiplier()
		
func setup_multiplier():
	var meter_size =Vector2(multiplier_meter_length, multiplier_meter_height * 2)
	$Multipliers.rect_position = multiplier_position
	$Multipliers.set_size(Vector2(meter_size.x * 5, meter_size.y))
	
	for multiplier in $Multipliers.get_children():
		multiplier.percent_visible = false
		multiplier.value = 0
		multiplier.rect_size = meter_size
		multiplier.update()
	$Multipliers.update()

func on_enemy_destroyed(enemy, player):
	score += enemy.point_value
	$Score.text = \"Score \" + str(score)

func _process(delta):
	process(delta)

func process(delta):
	if Input.is_action_pressed(\"restart\") and PLAYER.dead:
		restart_game()

func restart_game():
	MOB.reset()
	PLAYER.reset()
	score = 0
	$ResetTimer.start(1)
	$SecondsLeft.visible = true
	$SecondsLeft.text = str(seconds_left)

func _on_ResetTimer_timeout():
	if seconds_left == 0:
		seconds_left = 3
		$SecondsLeft.visible = false
		MOB.start()
		PLAYER.start()
		$ResetTimer.stop()
	else:
		seconds_left -= 1
	# I don't love this double comparison but I don't know if it's worth the thought to make efficient
	if seconds_left == 0:
		$SecondsLeft.text = \"Go!\"
	else:	
		$SecondsLeft.text = str(seconds_left)
	
func on_bombs_left(bombs_left):
	var bombs_left_text = \"Bombs \"
	for i in range(bombs_left):
		bombs_left_text += \"* \"
	$BombsLeft.text = bombs_left_text

func _on_multiplier_changed(multiplier, meter_value, meter_max):
	$Multiplier.text = \"Multiplier \" + str(multiplier) + \"X\"
	$Multiplier.update()
	var percentage = clamp((meter_value * 100) / meter_max, 0, 100)
	print(meter_value, ', ', meter_max)
	print(percentage, \"Percentage\")
	var multiplier_index = multiplier - 1
	for index in range(len($Multipliers.get_children())):
		var child = $Multipliers.get_child(index)
		if index < multiplier_index:
			child.value = 100
		elif index == multiplier_index:
			child.value = int(percentage)
		else:
			child.value = 0
		child.update()

"

[sub_resource type="DynamicFontData" id=2]
font_path = "res://Resources/TypeFaces/dotty.regular.ttf"

[sub_resource type="DynamicFont" id=3]
size = 54
font_data = SubResource( 2 )

[sub_resource type="DynamicFontData" id=4]
font_path = "res://Resources/TypeFaces/dotty.regular.ttf"

[sub_resource type="DynamicFont" id=5]
size = 72
font_data = SubResource( 4 )

[sub_resource type="DynamicFontData" id=6]
font_path = "res://Resources/TypeFaces/dotty.regular.ttf"

[sub_resource type="DynamicFont" id=7]
size = 54
font_data = SubResource( 6 )

[sub_resource type="DynamicFont" id=8]
size = 72
font_data = ExtResource( 1 )

[sub_resource type="ParticlesMaterial" id=9]
gravity = Vector3( 0, 0, 0 )
angular_velocity = 100.0

[sub_resource type="CanvasItemMaterial" id=10]
next_pass = SubResource( 9 )
particles_animation = true
particles_anim_h_frames = 1
particles_anim_v_frames = 1
particles_anim_loop = false

[sub_resource type="StyleBoxLine" id=11]
color = Color( 0, 0.886275, 0.847059, 1 )
thickness = 10

[sub_resource type="StyleBoxLine" id=12]

[node name="HUD" type="CanvasLayer"]
script = SubResource( 1 )

[node name="Score" type="Label" parent="."]
margin_top = 20.0
margin_right = 1280.0
margin_bottom = 58.0
custom_fonts/font = SubResource( 3 )
text = "Score 0"
align = 1
valign = 1
__meta__ = {
"_edit_use_anchors_": false
}

[node name="ResetTimer" type="Timer" parent="."]

[node name="SecondsLeft" type="Label" parent="."]
visible = false
margin_right = 1280.0
margin_bottom = 720.0
custom_fonts/font = SubResource( 5 )
text = "0"
align = 1
valign = 1

[node name="BombsLeft" type="Label" parent="."]
margin_left = 24.6133
margin_top = 676.865
margin_right = 24.6133
margin_bottom = 714.865
custom_fonts/font = SubResource( 7 )
valign = 2
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Multiplier" type="Label" parent="."]
margin_left = 1002.5
margin_top = 632.494
margin_right = 1239.5
margin_bottom = 682.494
custom_fonts/font = SubResource( 8 )
text = "Multiplier 1X"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Multipliers" type="HBoxContainer" parent="."]
margin_right = 952.0
margin_bottom = 40.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="OneX" type="ProgressBar" parent="Multipliers"]
material = SubResource( 10 )
margin_right = 187.0
margin_bottom = 20.0
size_flags_horizontal = 3
custom_styles/fg = SubResource( 11 )
custom_styles/bg = SubResource( 12 )
value = 100.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="TwoX" type="ProgressBar" parent="Multipliers"]
material = SubResource( 10 )
margin_left = 191.0
margin_right = 378.0
margin_bottom = 20.0
size_flags_horizontal = 3
custom_styles/fg = SubResource( 11 )
custom_styles/bg = SubResource( 12 )
value = 100.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="ThreeX" type="ProgressBar" parent="Multipliers"]
material = SubResource( 10 )
margin_left = 382.0
margin_right = 569.0
margin_bottom = 20.0
size_flags_horizontal = 3
custom_styles/fg = SubResource( 11 )
custom_styles/bg = SubResource( 12 )
value = 100.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="FourX" type="ProgressBar" parent="Multipliers"]
material = SubResource( 10 )
margin_left = 573.0
margin_right = 760.0
margin_bottom = 20.0
size_flags_horizontal = 3
custom_styles/fg = SubResource( 11 )
custom_styles/bg = SubResource( 12 )
value = 100.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="FiveX" type="ProgressBar" parent="Multipliers"]
material = SubResource( 10 )
margin_left = 764.0
margin_right = 952.0
margin_bottom = 20.0
size_flags_horizontal = 3
custom_styles/fg = SubResource( 11 )
custom_styles/bg = SubResource( 12 )
value = 100.0
__meta__ = {
"_edit_use_anchors_": false
}
[connection signal="timeout" from="ResetTimer" to="." method="_on_ResetTimer_timeout"]
